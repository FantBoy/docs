## 概述

UPYUN 内容分发网络（Content Delivery Networ），即 UPYUN CDN， 通过对用户源站内容进行加速分发，从而提升网站访问速度，适用于网站中的静态内容和其动态部分。除此之外，UPYUN CDN 还拥有缩略图处理、页面优化、安全防护、日志分析等特性。

## 整体架构

![UPYUN CDN Architecture](http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-architecture.png_/fw/800)

## 空间类型

目前主要分两大类：`云存储空间` 和 `CDN 空间`；其中 `CDN 空间` 当前还分为 `静态 CDN 空间` 和 `动态 CDN 空间`。

```
特别地，当前云存储空间已不再区分文件空间和图片空间，两者的功能特性均一致，故下面也不再进行字面上的区分，统一以云存储空间指代。
```

其中云存储空间表示资源都存放在 UPYUN 对象存储服务上，同时自带了 CDN 的支持，因此也拥有绝大多数 UPYUN CDN 的功能；而 CDN 空间则表示资源都存放在客户自己的源站或第三方云存储服务上，仅仅使用 UPYUN CDN 服务。

> 关于静态 CDN 空间和动态 CDN 空间

静态 CDN 空间适用于纯静态资源的加速，有做动静分离设计的网站，可以直接把静态资源放到静态 CDN 空间上进行加速，动态部分则直接回源；而动态 CDN 空间则适用于全站加速，即加速的内容除了静态部分外还有很多动态页面/数据请求，通常这部分动态请求不需要进行任何服务端缓存，同时，在用户源站没有设置任何缓存策略的情况下，我们会自动对加速内容进行动静分离，设置合理的缓存时间。

此外，动态 CDN 空间还默认开启了 `参数跟随` 和 `域名跟随` 特性，后续相关章节会详细介绍。

## 域名绑定

> 管理后台：通用 > 域名管理

> 空间类型：所有空间

----

无论是云存储空间还是 CDN 空间我们默认均提供了一个三级域下的子域名作为 CDN 访问域名使用，形式为 `<bucket>.b0.upaiyun.com`；当然我们也支持自定义域名的绑定，前提是该域名已经备案成功，否则无法通过域名绑定审核，另外，审核成功后会以邮件形式进行通知。

> 其中 `<bucket>` 请用实际空间名代替，下同。

以下是关于域名绑定的一些额外（重要）说明：

* 除常规形式的域名外，我们还支持泛域名绑定，比如 `*.yourdomain.com`；特别地，其中 `*` 暂时只支持匹配一层：

```
[v] *.yourdomain.com => foo.yourdomain.com
[v] *.yourdomain.com => bar.yourdomain.com
[x] *.yourdomain.com => foo.bar.yourdomain.com

[v] *.bar.yourdomain.com => foo.bar.yourdomain.com
[x] *.bar.yourdomain.com => doc.foo.bar.yourdomain.com
```

* 添加域名绑定后，需要到域名服务商的 DNS 解析管理中，将域名的 CNAME 解析到 `<bucket>.b0.aicdn.com`。

## 回源配置

> 管理后台：CDN 设置 > 基本设置

> 空间类型：CDN 空间

----

![CDN Source Settings](http://upyun-assets.b0.upaiyun.com/docs/cdn/cdn-source-settings.png_/fw/600)

### 回源 Host

可以选择 `域名跟随` 或者 `自定义` 回源 Host。

> 首先，先解释下什么是 `回源 Host`，它和 `回源地址` 有什么区别？

`回源 Host` 表示 CDN 回源时 HTTP 请求头中 Host 字段的值，一般是域名形式的字符串，当然也支持任意字符串形式；而 `回源地址` 则表示源站实际可访问的网络地址，可以直接填 IP 地址也可以填写域名地址，如果是域名地址，那么 CDN 在回源时会对该域名地址进行 DNS 解析，然后通过解析出来的 IP 地址再进行访问，因此若解析失败也会导致无法正常回源。

> 域名跟随

其中域名跟随表示该 CDN 空间实际回源域名总是和当前 CDN 访问域名保持一致，例如：

* 若用 `foo.yourdomain.com` 访问，那么回源 Host 就设置为 `foo.yourdomain.com`
* 若用 `bar.yourdomain.com` 访问，那么回源 Host 就设置为 `bar.yourdomain.com`

> 自定义

若选择自定义的方式，那么回源 Host 就设置为此处自定义的值。特别地，如果该自定义值为空，则该空间的原始域名就会作为回源 Host。

### 回源方式

默认情况，我们总是会以 `HTTP 协议回源`，当然你也可以选择 `HTTPS 协议回源`，那么所有回源请求都将以 HTTPS 协议访问源站，此时源站需要开启 HTTPS 支持并配置可用的证书。特别地，当我们选择 HTTP 协议回源时，回源地址的端口号默认为 `80`，而选择 HTTPS 协议回源时，端口号默认为 `443`，当然，你也可以手动指定特殊的端口号，例如 `8080` 或 `8443`。

> 协议跟随

另外一个特别的选项是 `协议跟随`，当启用该特性时，回源协议始终会和客户端访问 CDN 的协议保持一致，即客户端用 HTTP 协议访问我们 CDN，那么回源时我们也会用 HTTP 协议进行回源，同样，若 HTTPS 访问，那么回源也是 HTTPS。

特别地，选择协议跟随后，回源地址的端口号配置将仅作用于回源协议为 HTTP 的情况，默认 `80`，当然你也可以自定义为其他值，而回源协议为 HTTPS 时端口号则始终固定为 `443`，且目前暂时不支持修改此固定值。因此，若之前选择 `HTTPS 协议回源` 且自定义设置过端口号的用户需要注意，切换到 `协议跟随` 模式下时，自定义的端口号将仅作用于回源协议为 HTTP 的情况。

### 源站线路（多选）

目前我们支持 `电信`、`移动`、`联通`、`BGP` 及 `其它` 5 种源站线路配置。用户可以根据自身源站的网络情况选择合适的源站线路，例如源站有电信和联通双线地址，那么这里可以同时选择 `电信` 和 `联通` 并分别配置上相应回源地址等信息即可。

> 需要特别注意的是，这里的源站线路指的是客户源站自身的线路情况，而不是 UPYUN CDN 中转机房的回源线路情况。

因此，如果客户源站是 BGP 网络，那么这里直接选 `BGP` 即可，此时，我们任意线路的中转机房都会直接回该源站。如果客户源站是长宽、教育网等小众网络，那么这里可以选择 `其他` 线路，此时，我们就会调度到 BGP 的中转机房进行回源，以此确保回源质量。

### 回源地址

同一个源站线路可以允许配置多个回源地址，其中 `回源地址` 既可以填写 IP 地址也可以填写域名地址，当然，还可以自定义设置 `端口号`。

```
另外，关于 `回源地址` 和 `回源 Host` 的区别，以及 `端口号` 的默认值情况上面已经详细说明过了，这里就不再展开了。
```

> `线路属性` 和负载均衡策略

同一个源站线路回源地址配置中除了默认的 `主线路` 外，我们还支持 `备份线路` 的配置。默认情况下，主线路多个回源地址会以 RR 轮询方式进行调度，当且仅当所有主线路回源地址均不可达时，此时我们将使用备份线路进行转发，若备份线路有多个回源地址，那么负载均衡方式也和主线路一样，以 [Round-Robin](https://en.wikipedia.org/wiki/Round-robin_scheduling) 轮询方式进行调度。

> 轮询权重

```
轮询权重范围：整数（>=1）
```

默认情况下，轮询权重都为 1，表示所有回源地址轮询到的概率均等。当然也可以如上图那样自定义 `轮询权重`，我们看到主线路两个回源地址权重分别是 1 和 2，此时主线路集群在轮询调度中会有 1/3 的概率选中 `192.168.11.1:80` 这个节点，而选中 `192.168.11.2:80` 节点进行转发的概率则为 2/3。即当前节点轮询到的概率可按 `当前节点权重` / `集群所有节点权重之和` 这个公式计算。

> 最大失败次数和静默时间

```
最大失败次数范围：整数 (>=0) 静默时间范围：整数 (>=1)，单位秒
```

表示在一个 `静默时间 (fail_timeout)` 内如果该节点异常次数累计达到当前设置的 `最大失败次数 (max_fails)`，那么在下一个 `静默时间 (fail_timeout)` 内，我们就认为这个节点宕机了，即在这段时间内不会再将请求转发给它。特别地，当 `最大失败次数 (max_fails)` 其值为 0 时，表示不会进行失败累计，`静默时间 (fails_timeout)` 也同时失效。

合理设置最大失败次数和静默时间，有助于在后端异常的情况下最大程度减少对线上请求的影响。这里实际上跟 Nginx 核心的 upstream 模块实现机制类似，以下文档可供进一步参考： [http://nginx.org/en/docs/http/ngx_http_upstream_module.html#server](http://nginx.org/en/docs/http/ngx_http_upstream_module.html#server)
